// Generated by CoffeeScript 1.6.3
(function(){var e,t,n=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};t=function(e,t){var n,r,i;t==null&&(t=!1);n=e.match(/\.css(\?.*)?$/);e+="?t="+(new Date).getTime();r=document.createElement(n?"link":"script");n?(i=["text/css","stylesheet",e],r.type=i[0],r.rel=i[1],r.href=i[2]):r.src=e;r.addEventListener("load",function(e){if(t)return t(null,e)});return(n?document.body:document.head).appendChild(r)};e={folder:"Synappse/",file:"_project.json",user:{},client:new Dropbox.Client({key:"d1y1wxe9ow97xx0"}),checkAuth:function(){var e;e=this;return this.client.authenticate({interactive:!1},function(t,n){t&&console.log(t);if(n.isAuthenticated())return e.init()})},auth:function(){var e;e=this;return this.client.authenticate(function(t,n){t&&console.log(t);if(n.isAuthenticated())return e.init()})},init:function(){var e;e=this;this.client.getAccountInfo(function(t,n){return e.user={name:n.name,email:n.email,uid:n.uid}});return t("public/app.css",function(){return t("//ajax.googleapis.com/ajax/libs/angularjs/1.2.9/angular.min.js",function(){return t("//ajax.googleapis.com/ajax/libs/angularjs/1.2.9/angular-route.min.js",function(){return t("public/app.js",function(){return angular.element(document).ready(function(){return angular.bootstrap(document,["synappseApp"])})})})})})},readFolder:function(e,t){var n;n=this;return this.client.readdir(e,function(r,i,s,o){return r?n.client.mkdir(e,function(e,n){e&&console.log(e);return t([])}):t(o)})},checkProject:function(e,t,n){var r;r=this;return this.client.readFile(e+this.file,function(i,s,o){var u,a;if(i&&i.status===404){u=e.substring(r.folder.length+1).replace(/\/$/,"");a={name:u,id:generateID(3,t,r.user.uid+"_"),folder:e,slug:slug(u),users:[r.user],alerts:[],tasks:[],deletedTasks:[],comments:[],deletedComments:[]};return r.saveProject(a,function(){return n(a)})}a=angular.fromJson(decodeURIComponent(escape(s)));a.folder=e;return n(a)})},saveProject:function(e,t){t==null&&(t=!1);return this.client.writeFile(e.folder+this.file,unescape(encodeURIComponent(angular.toJson(e))),function(e,n){e&&console.log(e);if(t)return t()})},checkLocalProjects:function(e,t,r){var i,s,o,u,a,f,l,c,h,p,d;s=function(){var t,n,r;r=[];for(t=0,n=e.length;t<n;t++){o=e[t];r.push(o.id)}return r}();for(f=0,c=e.length;f<c;f++){o=e[f];if(p=o.folder,n.call(t,p)<0)if(o.id.length===2){o.id=generateID(3,s,this.user.uid+"_");o.users.push(this.user);d=o.tasks;for(l=0,h=d.length;l<h;l++){a=d[l];a.id=generateID(3,function(){var e,t,n,r;n=o.tasks;r=[];for(e=0,t=n.length;e<t;e++){u=n[e];r.push(u.id)}return r}())}this.saveProject(o)}else{i=s.indexOf(o.id);~i&&e.splice(i,1)}}return r()},sync:function(e,t){var r;if(!this.client)return t();r=this;return this.readFolder(this.folder,function(i){var s,o,u,a,f,l,c,h,p;f=function(){var e,t,n;n=[];for(e=0,t=i.length;e<t;e++){s=i[e];s.isFolder&&n.push(s)}return n}();l=f.length;if(!l)return r.checkLocalProjects(e,[],t);o=function(){var t,n,r;r=[];for(t=0,n=e.length;t<n;t++){u=e[t];r.push(u.id)}return r}();p=[];for(c=0,h=f.length;c<h;c++){a=f[c];p.push(r.checkProject(a.path+"/",o,function(i){var s,a,c;l--;if(c=i.id,n.call(o,c)<0)e.push(i);else{a=function(){var t,n,r;r=[];for(t=0,n=e.length;t<n;t++){u=e[t];u.id===i.id&&r.push(u)}return r}()[0];r.updateProject(a,i)}if(!l)return r.checkLocalProjects(e,function(){var e,t,n;n=[];for(e=0,t=f.length;e<t;e++){s=f[e];n.push(s.path+"/")}return n}(),function(){console.log("sync complete");return t()})}))}return p})},updateProject:function(e,t){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y;e.folder=t.folder;e.users=function(){var e,n,r,i;r=t.users;i=[];for(e=0,n=r.length;e<n;e++){s=r[e];i.push(s)}return i}();if(d=this.user.uid,n.call(function(){var t,n,r,i;r=e.users;i=[];for(t=0,n=r.length;t<n;t++){s=r[t];i.push(s.uid)}return i}(),d)>=0){v=e.users;for(o=0,l=v.length;o<l;o++){s=v[o];s.uid===this.user.uid&&(s=this.user)}}else e.users.push(this.user);e.tasks=this.solveConflicts(e.tasks,t.tasks,e.deletedTasks);e.comments=this.solveConflicts(e.comments,t.comments,e.deletedComments);e.deletedTasks=[];e.deletedComments=[];m=e.comments;for(u=0,c=m.length;u<c;u++){r=m[u];g=e.tasks;for(a=0,h=g.length;a<h;a++){i=g[a];i.oldID===r.taskID&&(r.taskID=i.id)}}y=e.tasks;for(f=0,p=y.length;f<p;f++){i=y[f];delete i.oldID}return this.saveProject(e)},solveConflicts:function(t,r,i){var s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x;s=function(){var e,t,n;n=[];for(e=0,t=r.length;e<t;e++){a=r[e];n.push(a.id)}return n}();t=angular.copy(function(){var e,r,i,o;o=[];for(u=e=0,r=t.length;e<r;u=++e){a=t[u];(a.id.length===2||(i=a.id,n.call(s,i)>=0))&&o.push(a)}return o}());for(p=0,g=t.length;p<g;p++){a=t[p];if(a.id.length!==2)continue;a.oldID=a.id;a.author=e.user.uid;a.id=generateID(3,s)}for(d=0,y=t.length;d<y;d++){c=t[d];if(c.id.length===3&&(E=c.id,n.call(s,E)>=0))for(v=0,b=r.length;v<b;v++){o=r[v];if(c.id===o.id&&c.edit<=o.edit)for(f in o){h=o[f];c[f]=h}}}l=function(){var e,n,r;r=[];for(e=0,n=t.length;e<n;e++){a=t[e];r.push(a.id)}return r}();for(m=0,w=r.length;m<w;m++){a=r[m];(S=a.id,n.call(l,S)<0)&&(x=a.id,n.call(i,x)<0)&&t.push(a)}return t}};(function(){e.checkAuth();return document.getElementById("dbauth").addEventListener("click",function(){return e.auth()})})()}).call(this);